@page "/siparislerim"
@using Uný_Proje.Web.Client.Services
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject SiparisServis SiparisServis

@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Sipariþlerim</PageTitle>

<style>
    .siparis-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .siparis-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
    }
    .durum-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .durum-onaylandi { background: #e3f2fd; color: #1976d2; }
    .durum-hazirlaniyor { background: #fff3e0; color: #f57c00; }
    .durum-kargoya_verildi { background: #e8f5e9; color: #388e3c; }
    .durum-teslim_edildi { background: #c8e6c9; color: #2e7d32; }
    .durum-iptal_edildi { background: #ffebee; color: #c62828; }
</style>

<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">
                    <i class="bi bi-box-seam me-2"></i>
                    Sipariþlerim
                </h2>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-house me-2"></i>
                    Ana Sayfa
                </a>
            </div>
        </div>
    </div>

    @if (yukleniyor)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-2 text-muted fs-5">Sipariþler yükleniyor...</p>
        </div>
    }
    else if (!siparisler.Any())
    {
        <div class="text-center my-5 py-5">
            <div class="fs-1 mb-3"><span>&#128230;</span></div>
            <h4 class="text-muted">Henüz Sipariþ Vermediniz</h4>
            <p class="text-muted">Alýþveriþe baþlamak için ürünlere göz atabilirsiniz.</p>
            <a href="/" class="btn btn-primary mt-3">
                <i class="bi bi-cart me-2"></i>
                Ürünlere Göz At
            </a>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var siparis in siparisler)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card siparis-card shadow-sm h-100" @onclick="() => DetayaGit(siparis.Id)">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">Sipariþ #@siparis.Id</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        @siparis.SiparisTarihi.ToString("dd.MM.yyyy HH:mm")
                                    </small>
                                </div>
                                <span class="durum-badge durum-@GetDurumClass(siparis.Durum)">
                                    @siparis.Durum
                                </span>
                            </div>

                            <hr />

                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Ürün Sayýsý:</span>
                                    <strong>@siparis.UrunSayisi adet</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Toplam Tutar:</span>
                                    <strong class="text-success fs-5">@siparis.ToplamTutar.ToString("N2") <span>&#8378;</span></strong>
                                </div>
                            </div>

                            <button class="btn btn-outline-primary w-100" @onclick:stopPropagation="true" @onclick="() => DetayaGit(siparis.Id)">
                                <i class="bi bi-eye me-2"></i>
                                Detaylarý Gör
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<SiparisListeDto> siparisler = new();
    private bool yukleniyor = true;

    protected override async Task OnInitializedAsync()
    {
        await SiparisleriYukle();
    }

    private async Task SiparisleriYukle()
    {
        yukleniyor = true;
        try
        {
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            
            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var (liste, hata) = await SiparisServis.SiparisleriGetir(token);
            siparisler = liste;
            
            if (!string.IsNullOrEmpty(hata))
            {
                await JSRuntime.InvokeVoidAsync("alert", $"? {hata}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"? Beklenmeyen hata: {ex.Message}");
        }
        finally
        {
            yukleniyor = false;
        }
    }

    private void DetayaGit(int siparisId)
    {
        Navigation.NavigateTo($"/siparis-detay/{siparisId}");
    }

    private string GetDurumClass(string durum)
    {
        return durum.ToLower().Replace(" ", "_").Replace("ý", "i").Replace("ð", "g");
    }
}
